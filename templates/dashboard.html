{% extends "layout.html" %}
{% block title %}Deals Dashboard - Agent Arbitrage{% endblock %}
{% block content %}
<h1>Deals Dashboard</h1>
<div class="filters-container">
    <form id="filter-form">
        <div class="filter-item">
            <label for="title_contains">Title Contains:</label>
            <input type="text" id="title_contains" name="title_like" class="styled-text-field">
        </div>
        <div class="filter-item">
            <label for="max_sales_rank_slider">Max Sales Rank: <span id="sales-rank-value">1.5m</span></label>
            <div class="slider-container">
                <input type="range" min="0" max="20" value="12" class="slider" id="max_sales_rank_slider">
                <input type="hidden" id="max_sales_rank" name="sales_rank_current_lte" value="1500000">
            </div>
        </div>
        <div class="filter-item">
            <label for="min_profit_margin_slider">Min % Profit: <span id="profit-margin-value">100%</span></label>
            <div class="slider-container">
                <input type="range" min="0" max="18" value="9" class="slider" id="min_profit_margin_slider">
                <input type="hidden" id="min_profit_margin" name="profit_margin_gte" value="100">
            </div>
        </div>
        <div class="filter-buttons">
            <button type="submit">Apply Filters</button>
            <button type="reset" id="reset-filters">Reset</button>
        </div>
    </form>
</div>
        <div class="table-container">
            <div id="deals-table"></div>
            <div class="pagination-controls">
                <button id="prev-page">Previous</button>
                <span id="page-info"></span>
                <button id="next-page">Next</button>
            </div>
        </div>
<div id="custom-tooltip" class="custom-tooltip"></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.container');
    if (container) {
        container.classList.remove('container');
        container.classList.add('container-full-width');
    }

    const tableContainer = document.getElementById('deals-table');
    const pageInfo = document.getElementById('page-info');
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    const filterForm = document.getElementById('filter-form');
    const resetBtn = document.getElementById('reset-filters');
    const tooltip = document.getElementById('custom-tooltip');
    const salesRankSlider = document.getElementById('max_sales_rank_slider');
    const salesRankValueSpan = document.getElementById('sales-rank-value');
    const hiddenSalesRankInput = document.getElementById('max_sales_rank');

    const profitMarginSlider = document.getElementById('min_profit_margin_slider');
    const profitMarginValueSpan = document.getElementById('profit-margin-value');
    const hiddenProfitMarginInput = document.getElementById('min_profit_margin');

    // --- New Slider Logic ---
    const salesRankSteps = [
        { value: 10000, label: '10k' }, { value: 50000, label: '50k' }, { value: 100000, label: '100k' },
        { value: 200000, label: '200k' }, { value: 300000, label: '300k' }, { value: 400000, label: '400k' },
        { value: 500000, label: '500k' }, { value: 600000, label: '600k' }, { value: 700000, label: '700k' },
        { value: 800000, label: '800k' }, { value: 900000, label: '900k' }, { value: 1000000, label: '1m' },
        { value: 1500000, label: '1.5m' }, { value: 2000000, label: '2m' }, { value: 2500000, label: '2.5m' },
        { value: 3000000, label: '3m' }, { value: 3500000, label: '3.5m' }, { value: 4000000, label: '4m' },
        { value: 4500000, label: '4.5m' }, { value: 5000000, label: '5m' }, { value: Infinity, label: '∞' }
    ];

    const profitMarginSteps = [
        { value: 20, label: '20%' }, { value: 30, label: '30%' }, { value: 40, label: '40%' },
        { value: 50, label: '50%' }, { value: 60, label: '60%' }, { value: 70, label: '70%' },
        { value: 80, label: '80%' }, { value: 90, label: '90%' }, { value: 100, label: '100%' },
        { value: 150, label: '150%' }, { value: 200, label: '200%' }, { value: 250, label: '250%' },
        { value: 300, label: '300%' }, { value: 350, label: '350%' }, { value: 400, label: '400%' },
        { value: 450, label: '450%' }, { value: 500, label: '500%' }, { value: Infinity, label: '∞' }
    ];

    // Set initial slider values based on defaults
    const initialSalesRankIndex = 12; // Default to 1.5m
    salesRankSlider.value = initialSalesRankIndex;
    salesRankValueSpan.textContent = salesRankSteps[initialSalesRankIndex].label;
    hiddenSalesRankInput.value = salesRankSteps[initialSalesRankIndex].value;

    const initialProfitMarginIndex = profitMarginSteps.findIndex(p => p.value === 100);
    if (initialProfitMarginIndex !== -1) {
        profitMarginSlider.value = initialProfitMarginIndex;
        profitMarginValueSpan.textContent = profitMarginSteps[initialProfitMarginIndex].label;
        hiddenProfitMarginInput.value = profitMarginSteps[initialProfitMarginIndex].value;
    }


    let currentPage = 1;
    let totalPages = 1;
    let currentSort = { by: 'id', order: 'asc' };

    const columnsToShow = [
        "Title", "ASIN", "Best_Price", "Min_Listing_Price", "All_in_Cost", "Profit", "Margin", "Seller", "Seller_Quality_Score",
        "Sales_Rank___Current", "last_price_change", "1yr_Avg", "Percent_Down", "Trend", "Binding", "Condition", "Seasonality_Type",
        "Expected_Peak_Price", "Expected_Trough_Price", "Profit_Confidence", "Deal_found", "Buy_Now"
    ];

    const headerTitleMap = {
        "last_price_change": "Changed",
        "Seller": "Seller Name",
        "Min_Listing_Price": "Min. List",
        "1yr_Avg": "1yr. Avg.",
        "Percent_Down": "% ⇩",
        "Seller_Quality_Score": "Seller Trust",
        "Sales_Rank___Current": "Sales Rank",
        "Binding": "Binding",
        "Condition": "Condition",
        "Seasonality_Type": "Seasonality",
        "Expected_Peak_Price": "Peak $",
        "Expected_Trough_Price": "Trough $",
        "Profit_Confidence": "Profit Reliability",
        "Deal_found": "Found"
    };

    function formatTimeAgo(dateString) {
        if (!dateString || dateString === '-') return '-';

        let date;
        // Handle "MM/DD/YY HH:MM" format specifically
        if (dateString.includes('/') && dateString.includes(':')) {
            const parts = dateString.split(' ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            // new Date(year, monthIndex, day, hours, minutes)
            date = new Date(
                2000 + parseInt(dateParts[2], 10),
                parseInt(dateParts[0], 10) - 1, // Month is 0-indexed
                parseInt(dateParts[1], 10),
                parseInt(timeParts[0], 10),
                parseInt(timeParts[1], 10)
            );
        } else {
            // Fallback for ISO format and other standard formats
            date = new Date(dateString);
        }

        if (isNaN(date.getTime())) {
            return '-'; // Safeguard against invalid dates
        }

        const now = new Date();
        const seconds = Math.round((now - date) / 1000);
        const minutes = Math.round(seconds / 60);

        if (minutes < 60) {
            if (minutes <= 1) return `1 <span class="time-suffix">min. ago</span>`;
            return `${minutes} <span class="time-suffix">mins. ago</span>`;
        }

        const hours = Math.round(minutes / 60);
        if (hours < 24) {
            if (hours === 1) return `1 <span class="time-suffix">hr. ago</span>`;
            return `${hours} <span class="time-suffix">hrs. ago</span>`;
        }

        const days = Math.round(hours / 24);
        if (days < 30) {
            if (days === 1) return `1 <span class="time-suffix">day ago</span>`;
            return `${days} <span class="time-suffix">days ago</span>`;
        }

        const months = Math.round(days / 30);
        if (months < 12) {
            if (months === 1) return `1 <span class="time-suffix">mo. ago</span>`;
            return `${months} <span class="time-suffix">mos. ago</span>`;
        }

        const years = Math.round(days / 365);
        if (years === 1) return `1<span class="time-suffix">yr. ago</span>`;
        return `${years}<span class="time-suffix">yrs. ago</span>`;
    }

    function formatCondition(value) {
        if (!value || typeof value !== 'string' || value.trim() === '-') return '-';

        const cleanedValue = value.toLowerCase().replace(/[\s_-]/g, '');

        const mapping = {
            'spiralbound': 'SB',
            'boardbook': 'BB',
            'hardcover': 'HC',
            'paperback': 'PB',
            'massmarketpaperback': 'MMPB',
            'audiobook': 'Audio',
            'audiocd': 'Audio',
            'looseleaf': 'LL',
            'leatherbound': 'LB',
            'likenew': 'LN',
            'verygood': 'VG',
            'good': 'G',
            'acceptable': 'A'
        };

        return mapping[cleanedValue] || value;
    }

    function getFilters() {
        const filters = {};
        // Manually get values from the form elements, including hidden inputs
        const title = document.getElementById('title_contains').value;
        const salesRank = hiddenSalesRankInput.value;
        const profitMargin = hiddenProfitMarginInput.value;

        if (title) filters['title_like'] = title;
        if (salesRank) filters['sales_rank_current_lte'] = salesRank;
        if (profitMargin) filters['profit_margin_gte'] = profitMargin;

        return filters;
    }

    async function fetchDeals(page = 1, sortBy = 'id', order = 'asc') {
        const limit = 50;
        const filters = getFilters();
        let query = `page=${page}&limit=${limit}&sort=${sortBy}&order=${order}`;
        for (const key in filters) {
            if (filters[key]) query += `&${key}=${encodeURIComponent(filters[key])}`;
        }

        try {
            const response = await fetch(`/api/deals?${query}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            renderTable(data.deals);
            renderPagination(data.pagination);
        } catch (error) {
            console.error('Error fetching deals:', error);
            tableContainer.innerHTML = '<p>Error loading deals. Please try again later.</p>';
        }
    }

    function renderTable(deals) {
        if (!deals || deals.length === 0) {
            tableContainer.innerHTML = '<p>No deals found matching the criteria.</p>';
            return;
        }

        let table = '<table><thead><tr>';
        columnsToShow.forEach(header => {
            let headerText = headerTitleMap[header] || header.replace(/_/g, ' ');

            let arrowsHtml = '';
            let thTag = '<th>';

            if (header !== 'Buy_Now') {
                const upArrowClass = (currentSort.by === header && currentSort.order === 'asc') ? 'on' : 'off';
                const downArrowClass = (currentSort.by === header && currentSort.order === 'desc') ? 'on' : 'off';
                arrowsHtml = `
                    <div class="sort-arrows-container">
                        <span class="sort-arrow sort-arrow-up ${upArrowClass}" data-order="asc">▲</span>
                        <span class="sort-arrow sort-arrow-down ${downArrowClass}" data-order="desc">▼</span>
                    </div>
                `;
                thTag = `<th data-sort="${header}">`;
            }
            
            table += `${thTag}<div class="th-content"><span>${headerText}</span>${arrowsHtml}</div></th>`;
        });
        table += '</tr></thead><tbody>';

        deals.forEach(deal => {
            let cleanAsin = deal.ASIN ? String(deal.ASIN).replace(/=|\"/g, '') : '';
            if (cleanAsin.length === 9) {
                cleanAsin = '0' + cleanAsin;
            }
            table += `<tr class="deal-row" data-asin="${cleanAsin}" style="cursor: pointer;">`;
            columnsToShow.forEach(col => {
                let value = deal[col] != null ? deal[col] : '-';
                // Re-written formatting logic for robustness
                const numValue = parseFloat(value);
                if (col === 'Seller_Quality_Score') {
                    if (!isNaN(numValue)) {
                        const score = Math.round(numValue * 10);
                        value = `<span>${score} <span class="trust-suffix">/ 10</span></span>`;
                    } else if (typeof value === 'string' && value.trim().toLowerCase() === 'new seller') {
                        value = `<span>Unrated</span>`;
                    } else if (typeof value === 'string' && value) {
                        // Handle other string values
                        value = `<span>${value}</span>`;
                    }
                } else if (col === 'Deal_found' || col === 'last_price_change') {
                    value = formatTimeAgo(value);
                } else if (!isNaN(numValue)) { // Check if the parsed value is a number
                    if (col === 'Profit_Confidence') {
                        value = `${Math.round(numValue)}%`;
                    } else if (col === 'Percent_Down') {
                        value = `${Math.round(numValue)}%`;
                    } else if (col === 'Sales_Rank___Current') {
                        value = numValue.toLocaleString('en-US');
                    } else if (col === 'Margin') {
                        value = `${numValue.toFixed(2)}%`;
                    } else if (col.includes('Price') || col.includes('Profit') || col.includes('Cost')) {
                        value = `$${numValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                } else if (col === 'Binding' || col === 'Condition') {
                    value = formatCondition(value);
                }

                if (col === 'Buy_Now') {
                    table += `<td><a href="https://www.amazon.com/dp/${cleanAsin}?psc=1&aod=1" target="_blank" onclick="event.stopPropagation()" class="buy-now-link">►</a></td>`;
                } else if (col === 'Title') {
                    const fullTitle = deal[col] || '';
                    table += `<td class="title-cell" data-full-title="${escape(fullTitle)}">${value}</td>`;
                } else if (col === 'Seller') {
                    table += `<td class="seller-cell">${value}</td>`;
                } else if (col === 'ASIN') {
                    table += `<td>${cleanAsin}</td>`;
                } else if (col === 'Best_Price' && cleanAsin) {
                    table += `<td><a href="https://www.amazon.com/dp/${cleanAsin}?psc=1&aod=1" target="_blank" class="best-price-link">${value}</a></td>`;
                }
                else {
                    table += `<td>${value}</td>`;
                }
            });
            table += '</tr>';
        });

        table += '</tbody></table>';
        tableContainer.innerHTML = table;
        
        // Add event listeners for navigation and sorting
        addEventListeners();
    }
    
    function addEventListeners() {
        document.querySelectorAll('#deals-table tbody tr').forEach(row => {
            row.addEventListener('click', () => {
                const asin = row.dataset.asin;
                if (asin) window.location.href = '/deal/' + asin;
            });
        });

        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.addEventListener('click', (e) => {
                e.stopPropagation();
                const th = arrow.closest('th');
                if (th) {
                    const sortBy = th.dataset.sort;
                    const order = arrow.dataset.order;
                    currentSort = { by: sortBy, order: order };
                    fetchDeals(currentPage, currentSort.by, currentSort.order);
                }
            });
        });
    }

    function renderPagination(pagination) {
        currentPage = pagination.current_page;
        totalPages = pagination.total_pages;
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevButton.disabled = currentPage <= 1;
        nextButton.disabled = currentPage >= totalPages;
    }

    filterForm.addEventListener('submit', e => {
        e.preventDefault();
        currentPage = 1;
        fetchDeals(currentPage, currentSort.by, currentSort.order);
    });

    resetBtn.addEventListener('click', () => {
        filterForm.reset();
        currentPage = 1;
        currentSort = { by: 'id', order: 'asc' };
        fetchDeals(currentPage, currentSort.by, currentSort.order);
    });

    prevButton.addEventListener('click', () => {
        if (currentPage > 1) fetchDeals(currentPage - 1, currentSort.by, currentSort.order);
    });

    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) fetchDeals(currentPage + 1, currentSort.by, currentSort.order);
    });

    salesRankSlider.addEventListener('input', () => {
        const stepIndex = parseInt(salesRankSlider.value);
        const step = salesRankSteps[stepIndex];
        salesRankValueSpan.textContent = step.label;
        hiddenSalesRankInput.value = (step.value === Infinity) ? '99999999' : step.value;
    });

    profitMarginSlider.addEventListener('input', () => {
        const stepIndex = parseInt(profitMarginSlider.value);
        const step = profitMarginSteps[stepIndex];
        profitMarginValueSpan.textContent = step.label;
        hiddenProfitMarginInput.value = (step.value === Infinity) ? '9999' : step.value;
    });

    fetchDeals();
});
</script>
{% endblock %}