{% extends "layout.html" %}
{% block title %}Deals Dashboard - Agent Arbitrage{% endblock %}
{% block content %}
<div id="recalc-indicator" class="recalc-indicator">
    Recalculating deals with new settings... The table will refresh automatically when complete.
</div>
<div class="dashboard-content-wrapper">
    <div id="sticky-header-shadow-line"></div>
    <div class="filter-panel filter-panel-open" id="filter-panel">
        <!-- CLOSED STATE -->
        <div class="panel-content-closed" id="panel-closed">
            <div class="panel-left">
                <img src="{{ url_for('static', filename='filter_Close.svg') }}" class="filter-icon-toggle" id="filter-icon-closed" alt="Filter">
                <span class="deals-found-text" id="deal-counter-closed">0 Deals Found</span>
            </div>
            <div class="panel-right">
                <span class="new-deals-text" id="new-deals-text" style="display: none;">0 New Deals found</span>
                <a href="#" class="refresh-link-panel" id="refresh-link-closed">
                    <img src="{{ url_for('static', filename='refresh.svg') }}" alt="Refresh">
                    <span class="refresh-text-white" id="refresh-text-closed">Refresh Now</span>
                </a>
            </div>
        </div>

        <!-- OPEN STATE -->
        <div class="panel-content-open" id="panel-open">
            <div class="panel-left">
                 <img src="{{ url_for('static', filename='filter_Open.svg') }}" class="filter-icon-toggle" id="filter-icon-open" alt="Filter">
                 <form id="filter-form-new" class="sliders-wrapper">
                     <!-- Min. Below Avg. -->
                     <div class="filter-item">
                        <label for="percent_down_slider">Min. Below Avg.: <span id="percent-down-value" class="slider-value-readout">Any</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="100" value="0" class="custom-slider" id="percent_down_slider">
                            <input type="hidden" id="percent_down" name="percent_down_gte" value="0">
                        </div>
                    </div>
                    <!-- Min. Profit -->
                    <div class="filter-item">
                        <label for="profit_slider">Min. Profit: <span id="profit-value" class="slider-value-readout">$0+</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="100" value="0" class="custom-slider" id="profit_slider">
                            <input type="hidden" id="profit" name="profit_gte" value="0">
                        </div>
                    </div>
                    <!-- Min. Margin -->
                    <div class="filter-item">
                        <label for="min_profit_margin_slider">Min. Margin: <span id="profit-margin-value" class="slider-value-readout">0%+</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="20" value="0" class="custom-slider" id="min_profit_margin_slider">
                            <input type="hidden" id="min_profit_margin" name="margin_gte" value="0">
                        </div>
                    </div>
                    <!-- Max. Sales Rank -->
                    <div class="filter-item">
                        <label for="max_sales_rank_slider">Max. Sales Rank: <span id="sales-rank-value" class="slider-value-readout">Any</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="20" value="20" class="custom-slider" id="max_sales_rank_slider">
                            <input type="hidden" id="max_sales_rank" name="sales_rank_current_lte" value="99999999">
                        </div>
                    </div>
                    <!-- Min. Profit Trust -->
                    <div class="filter-item">
                        <label for="profit_confidence_slider">Min. Profit Trust: <span id="profit-confidence-value" class="slider-value-readout">Any</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="100" value="0" class="custom-slider" id="profit_confidence_slider">
                            <input type="hidden" id="profit_confidence" name="profit_confidence_gte" value="0">
                        </div>
                    </div>
                    <!-- Min. Seller Trust -->
                    <div class="filter-item">
                        <label for="seller_trust_slider">Min. Seller Trust: <span id="seller-trust-value" class="slider-value-readout">Any</span></label>
                        <div class="slider-container-new">
                            <input type="range" min="0" max="10" value="0" class="custom-slider" id="seller_trust_slider">
                            <input type="hidden" id="seller_trust" name="seller_trust_gte" value="0">
                        </div>
                    </div>

                     <!-- New Checkboxes -->
                     <div class="checkboxes-wrapper">
                         <div class="checkbox-item">
                             <input type="checkbox" id="hide_gated" name="hide_gated" class="custom-checkbox">
                             <label for="hide_gated">Hide Gated</label>
                         </div>
                         <div class="checkbox-item">
                             <input type="checkbox" id="hide_amz" name="hide_amz" class="custom-checkbox">
                             <label for="hide_amz">Hide AMZ Offers</label>
                         </div>
                     </div>
                 </form>
            </div>
            <div class="panel-right-buttons">
                <button type="button" class="filter-btn" id="btn-apply">Apply</button>
                <button type="button" class="filter-btn" id="btn-reset">Reset</button>
            </div>
        </div>
    </div>
    <div class="table-container">
        <div id="deals-table"></div>
        <div id="pagination-container" class="pagination-controls">
            <!-- Pagination will be dynamically rendered here by JavaScript -->
        </div>
    </div>
</div>
<div id="custom-tooltip" class="custom-tooltip"></div>

<div id="deal-overlay" class="deal-overlay">
    <div class="deal-overlay-content">
        <span class="close-overlay">&times;</span>

        <div id="ava-advice-container" class="ava-advice-container">
            <div class="advice-header-wrapper">
                <div class="advice-title-section">
                     <img src="" class="active-mentor-img" id="active-mentor-icon" alt="Mentor">
                     <h3>Purchase Analysis & Advice
                        <div id="ava-spinner" class="spinner-inline"></div>
                     </h3>
                </div>
                <div class="mentor-selector-container">
                    <span class="mentor-label">Choose Your Mentor:</span>
                    <div class="mentor-icons-list" id="advice-mentor-list">
                        <!-- Dynamic content via JS -->
                    </div>
                </div>
            </div>
            <p id="ava-advice-text">Analyzing...</p>
        </div>

        <div class="overlay-action-bar">
            <!-- Action buttons injected dynamically -->
        </div>

        <div class="overlay-grid">
            <!-- Group 1: Book Details -->
            <div class="grid-group">
                <div class="overlay-group-header">Book Details</div>
                <div class="overlay-group-row"><span class="label">ASIN</span><span class="value" id="overlay-asin"></span></div>
                <div class="overlay-group-row"><span class="label">Title</span><span class="value truncated" id="overlay-title" title=""></span></div>
                <div class="overlay-group-row"><span class="label">Genre</span><span class="value truncated" id="overlay-genre" title=""></span></div>
                <div class="overlay-group-row"><span class="label">Binding</span><span class="value" id="overlay-binding"></span></div>
                <div class="overlay-group-row"><span class="label">Condition</span><span class="value" id="overlay-condition"></span></div>
                <div class="overlay-group-row"><span class="label">Publisher</span><span class="value truncated" id="overlay-publisher" title=""></span></div>
                <div class="overlay-group-row"><span class="label">Published</span><span class="value" id="overlay-published"></span></div>
                <div class="overlay-sub-header">Seller Details</div>
                <div class="overlay-group-row"><span class="label">Name</span><span class="value truncated" id="overlay-seller-name" title=""></span></div>
                <div class="overlay-group-row"><span class="label">Trust</span><span class="value" id="overlay-seller-trust"></span></div>
            </div>

            <!-- Group 2: Sales Rank -->
            <div class="grid-group">
                <div class="overlay-group-header">Sales Rank</div>
                <div class="overlay-group-row"><span class="label">Current</span><span class="value" id="overlay-rank-current"></span></div>
                <div class="overlay-group-row"><span class="label">180 Days Avg</span><span class="value" id="overlay-rank-180"></span></div>
                <div class="overlay-group-row"><span class="label">365 Days Avg</span><span class="value" id="overlay-rank-365"></span></div>
                <div class="overlay-sub-header">Rank Drops</div>
                <div class="overlay-group-row"><span class="label">Last 180 Days</span><span class="value" id="overlay-drops-180"></span></div>
                <div class="overlay-group-row"><span class="label">Last 365 Days</span><span class="value" id="overlay-drops-365"></span></div>
                <div class="overlay-sub-header">Used Offer Counts</div>
                <div class="overlay-group-row"><span class="label">Current</span><span class="value" id="overlay-offers-current"></span></div>
                <div class="overlay-group-row"><span class="label">Last 180 Days</span><span class="value" id="overlay-offers-180"></span></div>
                <div class="overlay-group-row"><span class="label">Last 365 Days</span><span class="value" id="overlay-offers-365"></span></div>
            </div>

            <!-- Group 3: Deal & Price Benchmarks -->
            <div class="grid-group">
                <div class="overlay-group-header">Deal & Price Benchmarks</div>
                <div class="overlay-group-row"><span class="label">Now</span><span class="value" id="overlay-price-now"></span></div>
                <div class="overlay-group-row"><span class="label">Shipping Included</span><span class="value" id="overlay-shipping"></span></div>
                <div class="overlay-group-row"><span class="label">1yr Avg</span><span class="value" id="overlay-price-1yr"></span></div>
                <div class="overlay-group-row"><span class="label">% ⇩ Avg</span><span class="value" id="overlay-percent-down"></span></div>
                <div class="overlay-group-row"><span class="label">Price Trending</span><span class="value" id="overlay-trend"></span></div>
                <div class="overlay-group-row"><span class="label">Updated</span><span class="value" id="overlay-updated"></span></div>
                <div class="overlay-group-row"><span class="label">Amazon - Current</span><span class="value" id="overlay-amz-current"></span></div>
                <div class="overlay-group-row"><span class="label">Amazon - 1yr Avg</span><span class="value" id="overlay-amz-1yr"></span></div>
                <div class="overlay-group-row"><span class="label">Buy Box Used - Current</span><span class="value" id="overlay-bb-current"></span></div>
                <div class="overlay-group-row"><span class="label">Buy Box Used - 1yr Avg</span><span class="value" id="overlay-bb-1yr"></span></div>
            </div>

            <!-- Group 4: Listing & Profit Estimates -->
            <div class="grid-group">
                <div class="overlay-group-header">Listing & Profit Estimates</div>
                <div class="overlay-group-row"><span class="label">Estimate Trust</span><span class="value" id="overlay-trust"></span></div>
                <div class="overlay-group-row"><span class="label">Profit:</span><span class="value" id="overlay-profit-val"></span></div>
                <div class="overlay-group-row"><span class="label">Margin:</span><span class="value" id="overlay-margin-val"></span></div>
                <div class="overlay-group-row"><span class="label">Max. List at:</span><span class="value" id="overlay-max-list"></span></div>
                <div class="overlay-group-row"><span class="label">Min. List at:</span><span class="value" id="overlay-min-list"></span></div>
                <div class="overlay-sub-header">Seasonality</div>
                <div class="overlay-group-row"><span class="label">Selling Season</span><span class="value" id="overlay-season"></span></div>
                <div class="overlay-group-row"><span class="label">Est. Sell Date</span><span class="value" id="overlay-sell-date"></span></div>
                <div class="overlay-group-row"><span class="label">Est. Buy Date</span><span class="value" id="overlay-buy-date"></span></div>
                <div class="overlay-group-row"><span class="label">Est. Buy Price</span><span class="value" id="overlay-buy-price"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    /* Container logic removed as per instructions to remove layout container */

    const tableContainer = document.getElementById('deals-table');
    // const filterForm = document.getElementById('filter-form'); // Removed
    const btnApply = document.getElementById('btn-apply');
    const btnReset = document.getElementById('btn-reset');
    const filterPanel = document.getElementById('filter-panel');
    const filterIconClosed = document.getElementById('filter-icon-closed');
    const filterIconOpen = document.getElementById('filter-icon-open');
    const tooltip = document.getElementById('custom-tooltip');

    const salesRankSlider = document.getElementById('max_sales_rank_slider');
    const salesRankValueSpan = document.getElementById('sales-rank-value');
    const hiddenSalesRankInput = document.getElementById('max_sales_rank');

    const profitMarginSlider = document.getElementById('min_profit_margin_slider');
    const profitMarginValueSpan = document.getElementById('profit-margin-value');
    const hiddenProfitMarginInput = document.getElementById('min_profit_margin');

    const profitConfidenceSlider = document.getElementById('profit_confidence_slider');
    const profitConfidenceValueSpan = document.getElementById('profit-confidence-value');
    const hiddenProfitConfidenceInput = document.getElementById('profit_confidence');

    const sellerTrustSlider = document.getElementById('seller_trust_slider');
    const sellerTrustValueSpan = document.getElementById('seller-trust-value');
    const hiddenSellerTrustInput = document.getElementById('seller_trust');

    const profitSlider = document.getElementById('profit_slider');
    const profitValueSpan = document.getElementById('profit-value');
    const hiddenProfitInput = document.getElementById('profit');

    const percentDownSlider = document.getElementById('percent_down_slider');
    const percentDownValueSpan = document.getElementById('percent-down-value');
    const hiddenPercentDownInput = document.getElementById('percent_down');

    const hideGatedInput = document.getElementById('hide_gated');
    const hideAmzInput = document.getElementById('hide_amz');

    const dealCounterClosed = document.getElementById('deal-counter-closed');
    const refreshLinkClosed = document.getElementById('refresh-link-closed');
    const refreshTextClosed = document.getElementById('refresh-text-closed');
    const newDealsText = document.getElementById('new-deals-text');

    // --- New Slider Logic ---
    const salesRankSteps = [
        { value: 10000, label: '10k' }, { value: 50000, label: '50k' }, { value: 100000, label: '100k' },
        { value: 200000, label: '200k' }, { value: 300000, label: '300k' }, { value: 400000, label: '400k' },
        { value: 500000, label: '500k' }, { value: 600000, label: '600k' }, { value: 700000, label: '700k' },
        { value: 800000, label: '800k' }, { value: 900000, label: '900k' }, { value: 1000000, label: '1m' },
        { value: 1500000, label: '1.5m' }, { value: 2000000, label: '2m' }, { value: 2500000, label: '2.5m' },
        { value: 3000000, label: '3m' }, { value: 3500000, label: '3.5m' }, { value: 4000000, label: '4m' },
        { value: 4500000, label: '4.5m' }, { value: 5000000, label: '5m' }, { value: Infinity, label: 'Any' }
    ];

    const profitMarginSteps = [
        { value: 0, label: '0%+' }, { value: 10, label: '10%' }, { value: 20, label: '20%' }, { value: 30, label: '30%' },
        { value: 40, label: '40%' }, { value: 50, label: '50%' }, { value: 60, label: '60%' },
        { value: 70, label: '70%' }, { value: 80, label: '80%' }, { value: 90, label: '90%' },
        { value: 100, label: '100%' }, { value: 150, label: '150%' }, { value: 200, label: '200%' },
        { value: 250, label: '250%' }, { value: 300, label: '300%' }, { value: 350, label: '350%' },
        { value: 400, label: '400%' }, { value: 450, label: '450%' }, { value: 500, label: '500%' },
        { value: Infinity, label: '∞' }
    ];

    // Set initial slider values based on defaults
    const initialSalesRankIndex = salesRankSteps.findIndex(s => s.value === Infinity);
    salesRankSlider.value = initialSalesRankIndex;
    salesRankValueSpan.textContent = salesRankSteps[initialSalesRankIndex].label;
    hiddenSalesRankInput.value = (salesRankSteps[initialSalesRankIndex].value === Infinity) ? '99999999' : salesRankSteps[initialSalesRankIndex].value;

    const initialProfitMarginIndex = profitMarginSteps.findIndex(p => p.value === 0);
    if (initialProfitMarginIndex !== -1) {
        profitMarginSlider.value = initialProfitMarginIndex;
        profitMarginValueSpan.textContent = profitMarginSteps[initialProfitMarginIndex].label;
        hiddenProfitMarginInput.value = profitMarginSteps[initialProfitMarginIndex].value;
    }


    let currentPage = 1;
    let totalPages = 1;
    let currentSort = { by: 'last_price_change', order: 'desc' };
    let currentDeals = [];
    // Use the global agent_mentor key now
    let currentMentor = localStorage.getItem('agent_mentor') || 'olyvia';
    let currentAsin = null;

    // Fallback mapping for deal overlay images (since new ones are managed in mentor_chat.js mainly)
    const DEAL_MENTORS = {
        'olyvia': { small: 'small_Olivia.png', tiny: 'tiny_Olivia.png', name: 'Olyvia' },
        'joel': { small: 'small_Joel.png', tiny: 'tiny_Joel.png', name: 'Joel' },
        'evelyn': { small: 'small_Evelyn.png', tiny: 'tiny_Evelyn.png', name: 'Evelyn' },
        'errol': { small: 'small_Errol.png', tiny: 'tiny_Errol.png', name: 'Errol' }
    };

    const overlay = document.getElementById('deal-overlay');
    const closeOverlayBtn = document.querySelector('#deal-overlay .close-overlay');

    const columnsToShow = [
        // Book Details
        "ASIN", "Title", "Condition",
        // Supply & Demand
        "Sales_Rank_Current", "Drops", "Offers", "Detailed_Seasonality",
        // Deal Details
        "1yr_Avg", "Price_Now", "Percent_Down", "last_price_change",
        // Trust Ratings
        "Seller_Quality_Score", "Profit_Confidence",
        // Profit Estimates
        "All_in_Cost", "Profit", "Margin", "Gated"
    ];

    const groupEndColumns = ['Condition', 'Detailed_Seasonality', 'last_price_change', 'Profit_Confidence'];

    const headerTitleMap = {
        "Categories_Sub": "Genre",
        "Gated": "Action",
        "last_price_change": "Ago",
        "Seller": "Name",
        "Min_Listing_Price": "Min. List",
        "1yr_Avg": "1yr Avg",
        "Percent_Down": "% ⇩",
        "Seller_Quality_Score": "Seller",
        "Sales_Rank_Current": "Rank",
        "Drops": "Drops",
        "Offers": "Offers",
        "Sales_Rank_365_days_avg": "1yr. Avg",
        "Binding": "Binding",
        "Condition": "Condition",
        "Sells": "Sells",
        "Detailed_Seasonality": "Season",
        "AMZ": "AMZ",
        "List_at": "List at",
        "Profit_Confidence": "Estimate",
        "All_in_Cost": "All in",
        "Deal_found": "Found",
        "Buy_Now": "Buy",
        "Price_Now": "Now"
    };

    function formatTimeAgo(dateString) {
        if (!dateString || dateString === '-' || dateString === '') return '-';

        let date;
        // Handle "MM/DD/YY HH:MM" format specifically
        if (dateString.includes('/') && dateString.includes(':')) {
            const parts = dateString.split(' ');
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            // new Date(year, monthIndex, day, hours, minutes)
            date = new Date(
                2000 + parseInt(dateParts[2], 10),
                parseInt(dateParts[0], 10) - 1, // Month is 0-indexed
                parseInt(dateParts[1], 10),
                parseInt(timeParts[0], 10),
                parseInt(timeParts[1], 10)
            );
        } else {
            // Fallback for ISO format and other standard formats
            date = new Date(dateString);
        }

        if (isNaN(date.getTime())) {
            return '-'; // Safeguard against invalid dates
        }

        const now = new Date();
        const seconds = Math.round((now - date) / 1000);
        const minutes = Math.round(seconds / 60);

        if (minutes < 60) {
            if (minutes <= 1) return `1m`;
            return `${minutes}m`;
        }

        const hours = Math.round(minutes / 60);
        if (hours < 24) {
            return `${hours}h`;
        }

        const days = Math.round(hours / 24);
        if (days < 30) {
            return `${days}d`;
        }

        const months = Math.round(days / 30);
        if (months < 12) {
            return `${months}mo`;
        }

        const years = Math.round(days / 365);
        return `${years}y`;
    }

    function formatSalesRank(num) {
        if (num === null || num === undefined || num === '') return '-';
        if (typeof num === 'string') {
            num = parseFloat(num.replace(/,/g, ''));
        }
        if (isNaN(num)) return '-';

        if (num >= 1000000) {
            // 4.5M
            return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (num >= 1000) {
            // 120k
            return Math.round(num / 1000) + 'k';
        } else {
            return num.toString();
        }
    }

    function formatCondition(value) {
        if (!value || typeof value !== 'string' || value.trim() === '-' || value.trim() === '') return '-';

        let clean = value.trim();
        const lower = clean.toLowerCase();

        let prefix = '';
        let suffix = '';

        if (lower === 'n' || lower.startsWith('new')) prefix = 'New';
        else if (lower.startsWith('used') || lower.startsWith('u -') || lower.startsWith('u-')) prefix = 'U';
        else if (lower.startsWith('collectible') || lower.startsWith('c -') || lower.startsWith('c-')) prefix = 'C';

        // Extract suffix by checking presence
        if (lower.includes('like new') || lower.includes('likenew')) suffix = 'Like New';
        else if (lower.includes('very good') || lower.includes('verygood')) suffix = 'Very Good';
        else if (lower.includes('good')) suffix = 'Good';
        else if (lower.includes('acceptable')) suffix = 'Acceptable';
        else if (lower.includes('open box') || lower.includes('openbox')) suffix = 'Open Box';

        if (prefix === 'New') {
            if (suffix === 'Open Box') return 'New - Open Box';
            return 'New';
        }

        if (prefix && suffix) {
            return `${prefix} - ${suffix}`;
        }

        // Fallback/Legacy map
        const cleanedValue = value.toLowerCase().replace(/[\s_-]/g, '');
        const mapping = {
            'spiralbound': 'SB',
            'boardbook': 'BB',
            'hardcover': 'HC',
            'paperback': 'PB',
            'massmarketpaperback': 'MMPB',
            'audiobook': 'Audio',
            'audiocd': 'Audio',
            'looseleaf': 'LL',
            'leatherbound': 'LB',
            'likenew': 'U - Like New',
            'verygood': 'U - Very Good',
            'good': 'U - Good',
            'acceptable': 'U - Acceptable'
        };

        return mapping[cleanedValue] || value;
    }

    function getFilters() {
        const filters = {};
        // Manually get values from the form elements, including hidden inputs
        // const keyword = document.getElementById('keyword_search').value; // Removed
        const salesRank = hiddenSalesRankInput.value;
        const profitMargin = hiddenProfitMarginInput.value;
        const profitConfidence = hiddenProfitConfidenceInput.value;
        const sellerTrust = hiddenSellerTrustInput.value;
        const profit = hiddenProfitInput.value;
        const percentDown = hiddenPercentDownInput.value;

        // if (keyword) filters['keyword'] = keyword; // Removed

        // Only add filters if they deviate from "Show All" default logic ("Any")
        if (salesRank && salesRank !== '99999999') filters['sales_rank_current_lte'] = salesRank;
        if (profitMargin !== '') filters['margin_gte'] = profitMargin; // Send 0 to filter negatives
        if (profitConfidence && profitConfidence !== '0') filters['profit_confidence_gte'] = profitConfidence;
        if (sellerTrust && sellerTrust !== '0') filters['seller_trust_gte'] = sellerTrust;
        if (profit !== '') filters['profit_gte'] = profit; // Send 0 to filter negatives
        if (percentDown && percentDown !== '0') filters['percent_down_gte'] = percentDown;

        if (hideGatedInput.checked) filters['hide_gated'] = 1;
        if (hideAmzInput.checked) filters['hide_amz'] = 1;

        return filters;
    }

    async function fetchDeals(page = 1, sortBy = 'id', order = 'asc') {
        const limit = 50;
        const filters = getFilters();
        // Add timestamp to prevent caching
        let query = `page=${page}&limit=${limit}&sort=${sortBy}&order=${order}&_t=${new Date().getTime()}`;
        for (const key in filters) {
            if (filters[key]) query += `&${key}=${encodeURIComponent(filters[key])}`;
        }

        try {
            const response = await fetch(`/api/deals?${query}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            currentDeals = data.deals; // Store the deals
            renderTable(data.deals);
            renderPagination(data.pagination);
        } catch (error) {
            console.error('Error fetching deals:', error);
            tableContainer.innerHTML = '<p>Error loading deals. Please try again later.</p>';
        }
    }

    function renderTable(deals) {
        // Ensure the table headers are always visible, even if there are no deals.
        // This prevents the Playwright script from timing out.
        document.querySelector('#deals-table').style.visibility = 'visible';

        let table = '<table class="deal-table"><thead>';

        // Add the new group header row
        table += '<tr class="group-header">';
        table += '<th colspan="3" class="group-end">Book Details</th>';
        table += '<th colspan="4" class="group-end">Supply & Demand</th>';
        table += '<th colspan="4" class="group-end">Deal Details</th>';
        table += '<th colspan="2" class="group-end">Trust Rates</th>';
        table += '<th colspan="4">Profit Estimates</th>';
        table += '</tr>';

        // Main header row
        table += '<tr class="column-header-row">';
        columnsToShow.forEach(header => {
            let headerText = headerTitleMap[header] || header.replace(/_/g, ' ');
            let groupClass = groupEndColumns.includes(header) ? 'group-end' : '';
            table += `<th data-sort="${header}" class="${groupClass}">${headerText}</th>`;
        });
        table += '</tr>';

        // New sorting arrows row
        table += '<tr class="sort-arrows-row">';
        columnsToShow.forEach(header => {
            let groupClass = groupEndColumns.includes(header) ? 'group-end' : '';
            if (header === 'Buy_Now') {
                table += `<td class="${groupClass}"></td>`; // No arrows for these columns
            } else {
                const upArrowSrc = (currentSort.by === header && currentSort.order === 'asc') ? '/static/ascending-on.png' : '/static/ascending-off.png';
                const downArrowSrc = (currentSort.by === header && currentSort.order === 'desc') ? '/static/descending-on.png' : '/static/descending-off.png';
                table += `
                    <td class="${groupClass}">
                        <div class="sort-arrows-container">
                            <img src="${upArrowSrc}" class="sort-arrow"
                                 data-order="asc"
                                 data-column="${header}"
                                 onmouseover="this.src='/static/ascending-on.png'"
                                 onmouseout="this.src='${upArrowSrc}'">
                            <img src="${downArrowSrc}" class="sort-arrow"
                                 data-order="desc"
                                 data-column="${header}"
                                 onmouseover="this.src='/static/descending-on.png'"
                                 onmouseout="this.src='${downArrowSrc}'">
                        </div>
                    </td>`;
            }
        });
        table += '</tr></thead><tbody>';

        if (deals && deals.length > 0) {
            deals.forEach(deal => {
                let cleanAsin = deal.ASIN ? String(deal.ASIN).replace(/=|\"/g, '') : '';
                if (cleanAsin.length === 9) {
                    cleanAsin = '0' + cleanAsin;
                }
                table += `<tr class="deal-row" data-asin="${cleanAsin}" style="cursor: pointer;">`;
                columnsToShow.forEach(col => {
                    let groupClass = groupEndColumns.includes(col) ? 'group-end' : '';
                    let value = deal[col] != null ? deal[col] : '-';
                    // Re-written formatting logic for robustness
                    const numValue = parseFloat(value);
                    if (col === 'Seller_Quality_Score') {
                        if (!isNaN(numValue)) {
                            const score = Math.round(numValue * 10);
                            value = `<span>${score} <span class="trust-suffix">/ 10</span></span>`;
                        } else if (typeof value === 'string' && value.trim().toLowerCase() === 'new seller') {
                            value = `<span>Unrated</span>`;
                        } else if (typeof value === 'string' && value) {
                            // Handle other string values
                            value = `<span>${value}</span>`;
                        }
                    } else if (col === 'Deal_found') {
                        value = formatTimeAgo(value);
                    } else if (col === 'last_price_change') {
                        let timeAgo = formatTimeAgo(value);
                        let trendArrow = deal.Trend || '';
                        let arrowHtml = '';

                        if (trendArrow === '⇧') {
                             arrowHtml = '<img src="/static/Arrow_up.svg" class="trend-icon" alt="Up">';
                        } else if (trendArrow === '⇩') {
                             arrowHtml = '<img src="/static/Arrow_down.svg" class="trend-icon" alt="Down">';
                        } else if (trendArrow === '⇨') {
                             arrowHtml = '<img src="/static/Arrow_level.svg" class="trend-icon" alt="Flat">';
                        }

                        if (arrowHtml) {
                            value = `<span>${arrowHtml} ${timeAgo}</span>`;
                        } else {
                            value = timeAgo;
                        }
                    } else if (!isNaN(numValue)) { // Check if the parsed value is a number
                        if (col === 'Profit_Confidence') {
                            value = `${Math.round(numValue)}%`;
                        } else if (col === 'Percent_Down') {
                            value = `${Math.round(numValue)}%`;
                        } else if (col === 'Sales_Rank_Current' || col === 'Sales_Rank_365_days_avg') {
                            value = formatSalesRank(numValue);
                        } else if (col === 'Margin') {
                            value = `${numValue.toFixed(2)}%`;
                        } else if (col.includes('Price') || col.includes('Profit') || col.includes('Cost') || col === '1yr_Avg') {
                            value = `$${numValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        }
                    } else if (col === 'Binding') {
                        // Backend formats it, frontend just displays it with truncation class
                    } else if (col === 'Condition') {
                        value = formatCondition(value);
                    }

                    let tdContent = '';

                    if (col === 'Gated') {
                        let gatedContent = '';
                        switch (deal.restriction_status) {
                            case 'restricted':
                                if (deal.approval_url && deal.approval_url !== 'ERROR') {
                                    gatedContent = `<a href="${deal.approval_url}" target="_blank" class="approval-link btn-gated" onclick="event.stopPropagation()">Apply</a>`;
                                } else {
                                    gatedContent = `<span class="restricted-text" style="color: #ff4d4d; font-weight: bold;">Restricted</span>`;
                                }
                                break;
                            case 'not_restricted':
                                // Show Buy button (Greenish)
                                gatedContent = `<a href="https://www.amazon.com/dp/${cleanAsin}?psc=1&aod=1" target="_blank" class="approval-link btn-buy" onclick="event.stopPropagation()">Buy</a>`;
                                break;
                            case 'error':
                                gatedContent = '<span class="status-icon error" title="API Error">⚠</span>';
                                break;
                            case 'pending_check':
                                gatedContent = '<div class="spinner"></div>';
                                break;
                            default:
                                // Fallback to "View" if status unknown
                                gatedContent = `<a href="https://www.amazon.com/dp/${cleanAsin}?psc=1&aod=1" target="_blank" class="approval-link" style="background-color: #6c757d; border: 2px solid #5a6268;" onclick="event.stopPropagation()">View</a>`;
                        }
                        tdContent = `<td>${gatedContent}</td>`;
                        // Override tdContent to include class
                        tdContent = `<td class="${groupClass}">${gatedContent}</td>`;

                    } else if (col === 'Title') {
                        const fullTitle = deal[col] || '';
                        tdContent = `<td class="title-cell ${groupClass}" data-full-title="${escape(fullTitle)}"><span>${value}</span></td>`;
                    } else if (col === 'Categories_Sub') {
                        let displayValue = value;
                        if (typeof displayValue === 'string' && displayValue.startsWith('Subjects')) {
                            // Remove "Subjects" or "Subjects," from the start of the string
                            displayValue = displayValue.replace(/^Subjects,?\s*/, '');
                        }
                        // If the result is empty or just a hyphen, show the custom message
                        if (displayValue.trim() === '' || displayValue.trim() === '-') {
                            displayValue = 'No Subject Listed';
                        }
                        tdContent = `<td class="genre-cell ${groupClass}"><span>${displayValue}</span></td>`;
                    } else if (col === 'Detailed_Seasonality') {
                        tdContent = `<td class="season-detail-cell ${groupClass}"><span>${value}</span></td>`;
                    } else if (col === 'Binding') {
                        tdContent = `<td class="binding-cell ${groupClass}"><span>${value}</span></td>`;
                    } else if (col === 'Sells') {
                        tdContent = `<td class="sells-cell ${groupClass}"><span>${value}</span></td>`;
                    } else if (col === 'Seller') {
                        tdContent = `<td class="seller-cell ${groupClass}"><span>${value}</span></td>`;
                    } else if (col === 'ASIN') {
                        tdContent = `<td class="${groupClass}">${cleanAsin}</td>`;
                    } else if (col === 'Price_Now') {
                        tdContent = `<td class="price-now-cell ${groupClass}">${value}</td>`;
                    } else if (col === 'Offers') {
                        // Style the trend arrow - Offers arrows are placed BEFORE the number?
                        // "Arrows should be placed before data in all cases, not after."
                        // Currently format is "15 ↘" or "15 ↗" or "15 ⇨"
                        let cellContent = '';
                        if (value && typeof value === 'string') {
                            // Split value and arrow if possible, or just replace
                            // Assuming format "Count Arrow"
                            let arrow = '';
                            let count = value;

                            // Check for Diagonal Down (Falling/Good) -> Map to Vertical Down
                            if (value.includes('↘')) {
                                // arrow = '<span class="trend-falling-green" style="color: #01be0a;">&#x2193;</span>'; // Green Down
                                arrow = '<img src="/static/Arrow_down.svg" class="trend-icon" alt="Down">';
                                count = value.replace('↘', '').trim();
                            }
                            // Check for Diagonal Up (Rising/Bad) -> Map to Vertical Up
                            else if (value.includes('↗')) {
                                // arrow = '<span class="trend-rising-red" style="color: #dd080a;">&#x2191;</span>'; // Red Up
                                arrow = '<img src="/static/Arrow_up.svg" class="trend-icon" alt="Up">';
                                count = value.replace('↗', '').trim();
                            }
                            // Check for Flat Arrow (Right Hollow) -> Map to Solid Right Arrow
                            else if (value.includes('⇨')) {
                                // arrow = '<span style="color: #dc870d; font-weight: bold;">&rightarrow;</span>'; // Orange Right
                                arrow = '<img src="/static/Arrow_level.svg" class="trend-icon" alt="Flat">';
                                count = value.replace('⇨', '').trim();
                            }

                            if (arrow) {
                                // Place arrow before data
                                cellContent = `${arrow} ${count}`;
                            } else {
                                cellContent = `${value}`;
                            }
                        } else {
                            cellContent = `${value}`;
                        }

                        let wrapperStart = '<div class="offers-wrapper"><span class="offers-text">';
                        let wrapperEnd = '</span>';

                        // Add AMZN icon if needed
                        if (deal.AMZ === '⚠️') {
                             wrapperEnd += `<img src="/static/AMZ_Warn.svg" class="amz-warn-icon" alt="AMZ">`;
                        }
                        wrapperEnd += '</div>';

                        tdContent = `<td class="${groupClass}">${wrapperStart}${cellContent}${wrapperEnd}</td>`;

                    } else {
                        tdContent = `<td class="${groupClass}">${value}</td>`;
                    }
                    table += tdContent;
                });
                table += '</tr>';
                table += `<tr class="spacer-row"><td colspan="${columnsToShow.length}">&nbsp;</td></tr>`;
            });
        } else {
            table += `<tr><td colspan="${columnsToShow.length}" class="no-deals-message">No deals found matching the criteria.</td></tr>`;
        }

        tableContainer.innerHTML = table + '</tbody></table>';
        
        // Add event listeners for navigation and sorting
        addEventListeners();
    }
    
    function addEventListeners() {
        document.querySelectorAll('#deals-table tbody tr').forEach(row => {
            row.addEventListener('click', () => {
                const asin = row.dataset.asin;
                const deal = currentDeals.find(d => d.ASIN === asin);
                if (deal) {
                    populateOverlay(deal);
                    overlay.style.display = 'block';
                }
            });
        });

        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent row click navigation
                const sortBy = arrow.dataset.column;
                const order = arrow.dataset.order;
                if (sortBy && order) {
                    currentSort = { by: sortBy, order: order };
                    fetchDeals(currentPage, currentSort.by, currentSort.order);
                }
            });
        });
    }

    function renderPagination(pagination) {
        currentPage = pagination.current_page;
        totalPages = pagination.total_pages;
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = ''; // Clear existing controls

        const dealCount = pagination.total_records || 0;
        currentTotalRecords = dealCount; // Update global tracker with current FILTERED count
        dealCounterClosed.textContent = `${dealCount.toLocaleString()} Deals Found`;

        if (totalPages <= 1) return;

        let paginationHTML = '';

        // First & Previous Buttons
        paginationHTML += `<button class="page-btn" data-page="1" ${currentPage === 1 ? 'disabled' : ''}>First</button>`;
        paginationHTML += `<button class="page-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

        // Helper functions for page number logic
        const getPageButton = (page) => `<button class="page-btn ${page === currentPage ? 'active' : ''}" data-page="${page}">${page}</button>`;
        const ellipsis = `<span class="page-ellipsis">...</span>`;

        if (totalPages <= 7) { // Show all pages if 7 or fewer
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += getPageButton(i);
            }
        } else {
            paginationHTML += getPageButton(1); // Always show first page
            if (currentPage > 3) {
                paginationHTML += ellipsis;
            }
            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                paginationHTML += getPageButton(i);
            }
            if (currentPage < totalPages - 2) {
                paginationHTML += ellipsis;
            }
            paginationHTML += getPageButton(totalPages); // Always show last page
        }

        // Next & Last Buttons
        paginationHTML += `<button class="page-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
        paginationHTML += `<button class="page-btn" data-page="${totalPages}" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>`;

        paginationContainer.innerHTML = paginationHTML;

        // Add event listeners to new buttons
        paginationContainer.querySelectorAll('.page-btn').forEach(button => {
            button.addEventListener('click', () => {
                const page = parseInt(button.dataset.page);
                if (page && page !== currentPage && !button.disabled) {
                    fetchDeals(page, currentSort.by, currentSort.order);
                }
            });
        });
    }

    function toggleFilterPanel(open) {
        localStorage.setItem('filterPanelOpen', open);
        if (open) {
            filterPanel.classList.remove('filter-panel-closed');
            filterPanel.classList.add('filter-panel-open');
            document.documentElement.style.setProperty('--filter-panel-height', '102px');
        } else {
            filterPanel.classList.remove('filter-panel-open');
            filterPanel.classList.add('filter-panel-closed');
            document.documentElement.style.setProperty('--filter-panel-height', '43px');
        }
    }

    function initFilterPanelState() {
        const savedState = localStorage.getItem('filterPanelOpen');
        // Default to Open (true) if not set, otherwise parse string
        const isOpen = savedState === null ? true : (savedState === 'true');
        toggleFilterPanel(isOpen);
    }

    filterIconClosed.addEventListener('click', () => toggleFilterPanel(true));
    filterIconOpen.addEventListener('click', () => toggleFilterPanel(false));

    // Initialize state on load
    initFilterPanelState();

    btnApply.addEventListener('click', () => {
        currentPage = 1;
        fetchDeals(currentPage, currentSort.by, currentSort.order);
        // Removed toggleFilterPanel(false) to respect user preference
    });

    btnReset.addEventListener('click', (e) => {
        // Prevent default form reset to handle it manually for better control
        e.preventDefault();

        // Reset Sliders UI
        const initialSalesRankIndex = salesRankSteps.findIndex(s => s.value === Infinity);
        salesRankSlider.value = initialSalesRankIndex;
        salesRankValueSpan.textContent = 'Any';

        profitMarginSlider.value = 0; // Index 0 is 0%
        profitMarginValueSpan.textContent = '0%+';

        profitConfidenceSlider.value = 0;
        profitConfidenceValueSpan.textContent = 'Any';

        sellerTrustSlider.value = 0;
        sellerTrustValueSpan.textContent = 'Any';

        profitSlider.value = 0;
        profitValueSpan.textContent = 'Any';

        percentDownSlider.value = 0;
        percentDownValueSpan.textContent = 'Any';

        // Reset Hidden Inputs to defaults
        hiddenSalesRankInput.value = '99999999';
        hiddenProfitMarginInput.value = '0';
        hiddenProfitConfidenceInput.value = '0';
        hiddenSellerTrustInput.value = '0';
        hiddenProfitInput.value = '0';
        hiddenPercentDownInput.value = '0';

        // Reset Checkboxes
        hideGatedInput.checked = false;
        hideAmzInput.checked = false;

        // Reset State
        currentPage = 1;
        currentSort = { by: 'id', order: 'asc' };

        // Do NOT fetch immediately on reset as per requirements
        // "reset them to default 'Any' and then clicks the 'Apply' button"
    });

    salesRankSlider.addEventListener('input', () => {
        const stepIndex = parseInt(salesRankSlider.value);
        const step = salesRankSteps[stepIndex];
        salesRankValueSpan.textContent = step.label;
        hiddenSalesRankInput.value = (step.value === Infinity) ? '99999999' : step.value;
    });

    profitMarginSlider.addEventListener('input', () => {
        const stepIndex = parseInt(profitMarginSlider.value);
        const step = profitMarginSteps[stepIndex];
        profitMarginValueSpan.textContent = step.label;
        hiddenProfitMarginInput.value = (step.value === Infinity) ? '9999' : step.value;
    });

    profitConfidenceSlider.addEventListener('input', () => {
        const val = profitConfidenceSlider.value;
        if (val == 0) {
            profitConfidenceValueSpan.textContent = 'Any';
        } else {
            profitConfidenceValueSpan.textContent = val + '%';
        }
        hiddenProfitConfidenceInput.value = val;
    });

    sellerTrustSlider.addEventListener('input', () => {
        const val = sellerTrustSlider.value;
        if (val == 0) {
            sellerTrustValueSpan.textContent = 'Any';
        } else {
            sellerTrustValueSpan.textContent = val + '/10';
        }
        hiddenSellerTrustInput.value = val;
    });

    profitSlider.addEventListener('input', () => {
        const val = profitSlider.value;
        if (val == 0) {
            profitValueSpan.textContent = "$0+";
        } else if (val == 100) {
            profitValueSpan.textContent = '$100+';
        } else {
            profitValueSpan.textContent = '$' + val;
        }
        hiddenProfitInput.value = val;
    });

    percentDownSlider.addEventListener('input', () => {
        const val = percentDownSlider.value;
        if (val == 0) {
            percentDownValueSpan.textContent = 'Any';
        } else {
            percentDownValueSpan.textContent = val + '%';
        }
        hiddenPercentDownInput.value = val;
    });

    // --- Refresh Logic ---
    let currentTotalRecords = 0;

    refreshLinkClosed.addEventListener('click', async (e) => {
        e.preventDefault();
        refreshTextClosed.textContent = 'Refreshing...';

        try {
            await fetchDeals(currentPage, currentSort.by, currentSort.order);
            refreshTextClosed.textContent = 'Refresh Now';
            newDealsText.textContent = '0 New Deals found'; // Reset new count
            newDealsText.style.display = 'none'; // Hide it
        } catch (err) {
            console.error('Refresh failed:', err);
            refreshTextClosed.textContent = 'Refresh Failed';
            setTimeout(() => { refreshTextClosed.textContent = 'Refresh Now'; }, 3000);
        }
    });

    setInterval(async () => {
        try {
            // Include current filters in the poll request
            const filters = getFilters();
            let query = `?_t=${new Date().getTime()}`; // Always include timestamp
            const params = [];
            for (const key in filters) {
                if (filters[key]) params.push(`${key}=${encodeURIComponent(filters[key])}`);
            }
            if (params.length > 0) query += '&' + params.join('&');

            const response = await fetch(`/api/deal-count${query}`);
            const data = await response.json();
            const serverCount = data.count;
            const diff = serverCount - currentTotalRecords;

            if (diff > 0) {
                newDealsText.textContent = `${diff} New Deals found`;
                newDealsText.style.display = 'inline';
            } else {
                 newDealsText.textContent = '0 New Deals found';
                 newDealsText.style.display = 'none';
            }
        } catch (e) {
            console.error("Poll failed", e);
        }
    }, 60000); // 60 seconds

    // --- Recalculation Status Polling ---
    const recalcIndicator = document.getElementById('recalc-indicator');
    let pollInterval;

    async function checkRecalcStatus() {
        try {
            const response = await fetch('/api/recalc-status');
            const data = await response.json();

            if (data.status === 'Running') {
                recalcIndicator.style.display = 'block';
            } else if (data.status === 'Completed') {
                recalcIndicator.style.display = 'none';
                fetchDeals(currentPage, currentSort.by, currentSort.order); // Refresh table
                clearInterval(pollInterval); // Stop polling
            } else {
                 recalcIndicator.style.display = 'none';
                 clearInterval(pollInterval); // Stop polling on idle or error
            }
        } catch (error) {
            console.error('Error polling recalc status:', error);
            recalcIndicator.style.display = 'none';
            clearInterval(pollInterval);
        }
    }

    // Start polling immediately on page load to catch ongoing jobs, then set interval
    checkRecalcStatus();
    pollInterval = setInterval(checkRecalcStatus, 3000); // Poll every 3 seconds

    fetchDeals();

    function populateOverlay(deal) {
        // --- Book Details ---
        document.getElementById('overlay-asin').textContent = deal.ASIN || '-';

        const title = deal.Title || '-';
        document.getElementById('overlay-title').textContent = title;
        document.getElementById('overlay-title').title = title; // For hover tooltip

        const genre = deal.Categories_Sub || '-';
        document.getElementById('overlay-genre').textContent = genre;
        document.getElementById('overlay-genre').title = genre;

        document.getElementById('overlay-binding').textContent = deal.Binding || '-';
        document.getElementById('overlay-condition').textContent = formatCondition(deal.Condition) || '-';

        const publisher = deal.Manufacturer || '-';
        document.getElementById('overlay-publisher').textContent = publisher;
        document.getElementById('overlay-publisher').title = publisher;

        document.getElementById('overlay-published').textContent = deal.Publication_Date || '-';

        const seller = deal.Seller || '-';
        document.getElementById('overlay-seller-name').textContent = seller;
        document.getElementById('overlay-seller-name').title = seller;

        let sellerTrust = deal.Seller_Quality_Score;
        if (sellerTrust != null && !isNaN(parseFloat(sellerTrust))) {
             sellerTrust = Math.round(parseFloat(sellerTrust) * 10) + ' / 10';
        } else {
             sellerTrust = '-';
        }
        document.getElementById('overlay-seller-trust').textContent = sellerTrust;

        // --- Sales Rank ---
        document.getElementById('overlay-rank-current').textContent = formatSalesRank(deal.Sales_Rank_Current);
        document.getElementById('overlay-rank-180').textContent = formatSalesRank(deal['Sales Rank - 180 days avg.']);
        document.getElementById('overlay-rank-365').textContent = formatSalesRank(deal['Sales Rank - 365 days avg.']);

        document.getElementById('overlay-drops-180').textContent = deal['Sales Rank - Drops last 180 days'] || '-';
        document.getElementById('overlay-drops-365').textContent = deal['Sales Rank - Drops last 365 days'] || '-';

        // Format Offer Counts with arrows
        function formatOffers(val) {
             if (!val || val === '-') return '-';
             let text = String(val);
             if (text.includes('↘')) return text.replace('↘', ' ↘'); // Add space if needed
             if (text.includes('↗')) return text.replace('↗', ' ↗');
             return text;
        }

        document.getElementById('overlay-offers-current').textContent = formatOffers(deal.Offers);
        document.getElementById('overlay-offers-180').textContent = formatOffers(deal['Offers 180']);
        document.getElementById('overlay-offers-365').textContent = formatOffers(deal['Offers 365']);

        // --- Deal & Price Benchmarks ---
        document.getElementById('overlay-price-now').textContent = deal.Price_Now ? `$${parseFloat(deal.Price_Now).toFixed(2)}` : '-';

        // Shipping Included logic (assuming backend sends 'yes'/'no' or we infer)
        let shipping = deal['Shipping Included'] || '-';
        if (shipping.toLowerCase() === 'yes') shipping = 'Yes';
        else if (shipping.toLowerCase() === 'no') shipping = 'No';
        document.getElementById('overlay-shipping').textContent = shipping;

        document.getElementById('overlay-price-1yr').textContent = deal['1yr. Avg.'] ? `$${parseFloat(deal['1yr. Avg.']).toFixed(2)}` : '-';

        let pctDown = deal['% Down'] || deal['Percent_Down'];
        if (pctDown != null && !isNaN(parseFloat(pctDown))) {
            document.getElementById('overlay-percent-down').textContent = Math.round(parseFloat(pctDown)) + '%';
        } else {
            document.getElementById('overlay-percent-down').textContent = '-';
        }

        document.getElementById('overlay-trend').textContent = deal.Trend || '-';
        document.getElementById('overlay-updated').textContent = formatTimeAgo(deal.last_price_change);

        document.getElementById('overlay-amz-current').textContent = deal['Amazon - Current'] || '';
        document.getElementById('overlay-amz-1yr').textContent = deal['Amazon - 365 days avg.'] || '';
        document.getElementById('overlay-bb-current').textContent = deal['Buy Box Used - Current'] || '';
        document.getElementById('overlay-bb-1yr').textContent = deal['Buy Box Used - 365 days avg.'] || '';

        // --- Listing & Profit Estimates ---
        let trust = deal.Profit_Confidence;
        if (trust != null && !isNaN(parseFloat(trust))) {
            document.getElementById('overlay-trust').textContent = Math.round(parseFloat(trust)) + '%';
        } else {
            document.getElementById('overlay-trust').textContent = '-';
        }

        document.getElementById('overlay-profit-val').textContent = deal.Profit ? `$${parseFloat(deal.Profit).toFixed(2)}` : '-';
        document.getElementById('overlay-margin-val').textContent = deal.Margin ? `${parseFloat(deal.Margin).toFixed(2)}%` : '-';

        // Max List at (List at)
        let listAt = deal['List at'];
        // Remove $ if present to parse
        if (listAt && typeof listAt === 'string') listAt = listAt.replace('$','');
        document.getElementById('overlay-max-list').textContent = listAt ? `$${parseFloat(listAt).toFixed(2)}` : '-';

        // Min List at
        let minList = deal['Min. Listing Price'] || deal.Min_Listing_Price;
        document.getElementById('overlay-min-list').textContent = minList ? `$${parseFloat(minList).toFixed(2)}` : '-';

        // Seasonality
        document.getElementById('overlay-season').textContent = deal.Detailed_Seasonality || '-';
        document.getElementById('overlay-sell-date').textContent = deal.Sells || '-';
        document.getElementById('overlay-buy-date').textContent = deal['Trough Season'] || '-';
        document.getElementById('overlay-buy-price').textContent = deal['Expected Trough Price'] || '-';

        // --- Action Bar ---
        const actionBar = document.querySelector('.overlay-action-bar');

        let messageHtml = '';
        let buttonHtml = '';

        if (deal.restriction_status === 'restricted') {
            // Gated
            messageHtml = 'You are <strong class="action-strong-red">Not Approved</strong> to sell this title: ';
            const applyUrl = (deal.approval_url && deal.approval_url !== 'ERROR') ? deal.approval_url : 'https://sellercentral.amazon.com/hz/approvalrequest?asin=' + deal.ASIN;
            buttonHtml = `<a href="${applyUrl}" target="_blank" class="overlay-action-btn overlay-btn-apply">Apply Now</a>`;
        } else if (deal.restriction_status === 'not_restricted') {
            // Approved
            messageHtml = 'You are <strong class="action-strong-white">Approved</strong> to sell this title: ';
            const buyUrl = deal.ASIN ? `https://www.amazon.com/dp/${deal.ASIN}?psc=1&aod=1` : '#';
            buttonHtml = `<a href="${buyUrl}" target="_blank" class="overlay-action-btn overlay-btn-buy">Buy Now</a>`;
        } else if (deal.restriction_status === 'pending_check') {
             messageHtml = 'Checking approval status... <span class="spinner-small"></span>';
        } else {
             // Default / Error / Unknown
             messageHtml = 'Approval status unknown: ';
             const buyUrl = deal.ASIN ? `https://www.amazon.com/dp/${deal.ASIN}?psc=1&aod=1` : '#';
             // Use Apply style for fallback view but maybe neutral color if desired, currently using Apply Orange style or maybe keep generic
             // User requested specific colors for Buy (Green) and Apply (Orange).
             // For "View on Amazon" fallback, I'll use a generic style if needed, or default to Buy style but grey?
             // The previous code had "yellow-action-btn view-amazon-btn" where view-amazon-btn had opacity 0.7.
             // I will use a simple inline style or just the base class with a background override if needed, or just let it use the new classes.
             // Given the prompt "Restyle the Buy Now and Apply Now buttons...", I will use a grey fallback.
             buttonHtml = `<a href="${buyUrl}" target="_blank" class="overlay-action-btn" style="background-color: #6c757d; border: 2px solid #5a6268;">View on Amazon</a>`;
        }

        actionBar.innerHTML = `<span class="action-message">${messageHtml}</span> ${buttonHtml}`;

        // Load Ava Advice
        currentAsin = deal.ASIN;
        loadAvaAdvice(deal.ASIN);
    }

    function updateDealMentorUI() {
        if (!currentMentor || !DEAL_MENTORS[currentMentor]) {
             // Fallback if localstorage has old or invalid key
             currentMentor = 'olyvia';
             localStorage.setItem('agent_mentor', currentMentor);
        }

        const m = DEAL_MENTORS[currentMentor];

        // Update Main Icon
        const mainIcon = document.getElementById('active-mentor-icon');
        if (mainIcon) mainIcon.src = `/static/${m.small}`; // Using small for the header as per spec approximation

        // Update List (Show others)
        const list = document.getElementById('advice-mentor-list');
        if (list) {
            list.innerHTML = '';
            Object.keys(DEAL_MENTORS).forEach(key => {
                if (key === currentMentor) return;
                const other = DEAL_MENTORS[key];
                const img = document.createElement('img');
                img.src = `/static/${other.tiny}`;
                img.className = 'mentor-icon'; // Keep class for CSS sizing
                img.title = other.name;
                img.onclick = () => {
                    switchDealMentor(key);
                };
                list.appendChild(img);
            });
        }
    }

    function switchDealMentor(newKey) {
        currentMentor = newKey;
        localStorage.setItem('agent_mentor', currentMentor);
        updateDealMentorUI();

        // Notify other components (like Chat Window)
        window.dispatchEvent(new CustomEvent('mentorChanged', { detail: { mentor: newKey } }));

        if (currentAsin) {
             loadAvaAdvice(currentAsin);
        }
    }

    // Listen for changes from Chat Window
    window.addEventListener('mentorChanged', (e) => {
        if (e.detail.mentor && e.detail.mentor !== currentMentor) {
            currentMentor = e.detail.mentor;
            updateDealMentorUI();
            if (currentAsin) {
                 loadAvaAdvice(currentAsin);
            }
        }
    });

    // Initialize UI on load
    updateDealMentorUI();

    async function loadAvaAdvice(asin) {
        const adviceContainer = document.getElementById('ava-advice-text');
        const spinner = document.getElementById('ava-spinner');

        // Reset state
        adviceContainer.textContent = '';
        adviceContainer.style.fontStyle = 'italic';
        adviceContainer.textContent = 'Analyzing deal data...';
        spinner.style.display = 'inline-block';

        try {
            const response = await fetch(`/api/ava-advice/${asin}?mentor=${currentMentor}`);
            const data = await response.json();

            spinner.style.display = 'none';
            adviceContainer.style.fontStyle = 'normal';

            if (data.advice) {
                adviceContainer.textContent = data.advice;
            } else {
                adviceContainer.textContent = "Ava is taking a coffee break. Please try again later.";
            }
        } catch (error) {
            console.error('Error fetching Ava advice:', error);
            spinner.style.display = 'none';
            adviceContainer.textContent = "Could not reach Ava at the moment.";
        }
    }

    closeOverlayBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target == overlay) {
            overlay.style.display = 'none';
        }
    });

    // Shadow Line Scroll Logic
    const shadowLine = document.getElementById('sticky-header-shadow-line');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 10) {
            shadowLine.style.display = 'block';
        } else {
            shadowLine.style.display = 'none';
        }
    });

});
</script>
{% endblock %}
