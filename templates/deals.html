{% extends "layout.html" %}

{% block title %}Keepa Deals Query{% endblock %}

{% block content %}

<div class="settings-container">
    <p class="settings-description">
        Use this page to set the Keepa deals query. The query must be a valid JSON object.
    </p>

    <div id="recalc-indicator" class="recalc-indicator">
        Recalculating deals with new settings... The task status will update below.
    </div>

    <div class="settings-card card-no-margin">
        <form action="{{ url_for('deals') }}" method="post" class="settings-form">
            <input type="hidden" name="action" value="update_query">
            <div class="form-group">
                <label for="keepa_query">Keepa API Query</label>
                <textarea id="keepa_query" name="keepa_query" class="styled-text-field large-textarea" rows="20">{{ keepa_query }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="styled-button">Save Query</button>
            </div>
        </form>
    </div>

    <!-- Artificial Backfill Limiter -->
    <div class="settings-card card-warning">
        <h2>Artificial Backfill Limiter</h2>
        <p>
            Automatically stop the backfill process when the total deal count reaches a specific number.
            Useful for controlling costs during testing or maintaining a small database.
        </p>
        <form action="{{ url_for('deals') }}" method="post" class="settings-form">
            <input type="hidden" name="action" value="update_limit">

            <div class="form-group form-group-checkbox">
                <input type="checkbox" id="backfill_limit_enabled" name="backfill_limit_enabled" class="checkbox-margin" {% if limit_enabled %}checked{% endif %}>
                <label for="backfill_limit_enabled" class="label-bold">Enable Limit</label>
            </div>

            <div class="form-group">
                <label for="backfill_limit_count">Stop when Deal Count reaches:</label>
                <input type="number" id="backfill_limit_count" name="backfill_limit_count" value="{{ limit_count }}" class="styled-text-field input-limit">
            </div>

            <div class="form-actions">
                <button type="submit" class="styled-button btn-warning-style">Update Limit</button>
            </div>
        </form>
    </div>

    <div class="settings-card">
        <h2>Manual Data Refresh</h2>
        <p>
            Recalculate Profit, Margin, and All-in Cost for all deals in the database using the latest business settings.
            This does not call external APIs (Keepa/SP-API) but refreshes internal logic.
        </p>
        <button id="refresh-all-data" class="styled-button btn-info-style">Refresh All Data</button>
    </div>

    <div class="settings-card card-danger">
        <h2 class="danger-text">Danger Zone</h2>
        <p>
            Resetting the database will clear all existing deals and restart the backfill process from scratch.
            This action cannot be undone.
        </p>
        <button id="reset-db-btn" class="styled-button btn-danger-style">
            Reset Database & Restart Backfill
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Reset Database Logic ---
    document.getElementById('reset-db-btn').addEventListener('click', function() {
        if (confirm('Are you ABSOLUTELY SURE you want to delete all data and restart the backfill? This process will take hours.')) {
            fetch('/api/reset-database', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred.');
                });
        }
    });

    // --- Recalculation Logic ---
    const recalcIndicator = document.getElementById('recalc-indicator');
    const refreshButton = document.getElementById('refresh-all-data');
    let pollInterval;

    async function checkRecalcStatus() {
        try {
            const response = await fetch('/api/recalc-status');
            const data = await response.json();
            if (data.status === 'Running') {
                recalcIndicator.style.display = 'block';
                recalcIndicator.textContent = data.message || 'Recalculating...';
            } else {
                recalcIndicator.style.display = 'none';
                if (pollInterval) clearInterval(pollInterval);
            }
        } catch (error) {
            console.error('Error polling recalc status:', error);
            recalcIndicator.style.display = 'none';
            if (pollInterval) clearInterval(pollInterval);
        }
    }

    refreshButton.addEventListener('click', async () => {
        const userConfirmed = confirm("Are you sure? This will update business calculations for all deals currently in the database. It may take a few minutes.");
        if (!userConfirmed) {
            return;
        }

        try {
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            const response = await fetch('/api/refresh-all-deals', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                checkRecalcStatus(); // Immediately show indicator
                pollInterval = setInterval(checkRecalcStatus, 3000);
            } else {
                alert(`Error: ${data.message || 'Could not start refresh.'}`);
            }
        } catch (error) {
            alert('An error occurred while trying to start the refresh.');
        } finally {
            setTimeout(() => {
                refreshButton.disabled = false;
                refreshButton.textContent = 'Refresh All Data';
            }, 3000);
        }
    });

    // Initial check in case a job is already running
    checkRecalcStatus();
});
</script>
{% endblock %}
